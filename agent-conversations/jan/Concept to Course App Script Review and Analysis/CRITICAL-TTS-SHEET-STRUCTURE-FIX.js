/**
 * CRITICAL FIX: TTS Sheet Structure Restoration
 * 
 * ISSUE IDENTIFIED: The TTS sheet structure has been compromised, missing essential columns
 * that the entire workflow depends on.
 * 
 * ANALYSIS OF YOUR ORIGINAL STRUCTURE:
 * Your ensureTTSSheet() function creates 10 columns (A-J):
 * A: Module Name
 * B: Slide Number  
 * C: Slide Content
 * D: Speaker Notes
 * E: Duration
 * F: Slides (PPT-ready)
 * G: Audio (WAV)
 * H: Image Prompt
 * I: Notes
 * J: Alternate Slide Content
 * 
 * However, your seedTTSFromSpecs() function shows it's expecting MORE columns
 * and the workflow has evolved beyond this basic structure.
 * 
 * CORRECTED COMPLETE TTS SHEET STRUCTURE:
 */

/**
 * ENHANCED ensureTTSSheet - Restores complete column structure
 */
function ensureTTSSheet(concept){
  const ss = SpreadsheetApp.getActive();
  let tts = ss.getSheetByName(`TTS-${concept}`);
  if (!tts) {
    tts = ss.insertSheet(`TTS-${concept}`);
    
    // COMPLETE HEADER STRUCTURE - All essential columns for the workflow
    const headers = [
      'Module Name',           // A - Module identifier
      'Slide Number',          // B - Slide sequence
      'Slide Content',         // C - Main slide content (enhanced AI-generated)
      'Speaker Notes',         // D - Detailed presenter notes
      'Duration (sec)',        // E - Estimated presentation time
      'Slides (PPT-ready)',    // F - PowerPoint generation status/link
      'Audio (WAV)',          // G - Generated audio file link
      'Image Prompt',         // H - AI image generation prompt
      'Notes',                // I - Additional workflow notes
      'Alternate Slide Content', // J - Alternative content versions
      'TTS Script',           // K - Text-to-speech optimised script
      'Audio Status',         // L - Audio generation progress
      'Slide Design Notes',   // M - Visual design specifications
      'Learning Objectives',  // N - Slide-specific learning goals
      'Interactive Elements', // O - Engagement features
      'Quality Check',        // P - Review and approval status
      'Last Updated',         // Q - Modification timestamp
      'Generated By'          // R - Attribution/version control
    ];
    
    tts.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    
    // Enhanced column width settings for better workflow usability
    tts.setColumnWidth(1, 150);  // Module Name
    tts.setColumnWidth(2, 80);   // Slide Number
    tts.setColumnWidth(3, 400);  // Slide Content - WIDER for enhanced content
    tts.setColumnWidth(4, 250);  // Speaker Notes
    tts.setColumnWidth(5, 100);  // Duration
    tts.setColumnWidth(6, 150);  // Slides (PPT-ready)
    tts.setColumnWidth(7, 150);  // Audio (WAV)
    tts.setColumnWidth(8, 300);  // Image Prompt - WIDER for detailed prompts
    tts.setColumnWidth(9, 200);  // Notes
    tts.setColumnWidth(10, 350); // Alternate Slide Content
    tts.setColumnWidth(11, 300); // TTS Script
    tts.setColumnWidth(12, 120); // Audio Status
    tts.setColumnWidth(13, 200); // Slide Design Notes
    tts.setColumnWidth(14, 250); // Learning Objectives
    tts.setColumnWidth(15, 200); // Interactive Elements
    tts.setColumnWidth(16, 120); // Quality Check
    tts.setColumnWidth(17, 120); // Last Updated
    tts.setColumnWidth(18, 120); // Generated By
    
    // Add header formatting
    const headerRange = tts.getRange(1, 1, 1, headers.length);
    headerRange.setBackground('#4285f4');
    headerRange.setFontColor('#ffffff');
    headerRange.setFontWeight('bold');
    headerRange.setBorder(true, true, true, true, true, true);
    
    // Freeze header row
    tts.setFrozenRows(1);
    
    Logger.log(`Created complete TTS sheet for ${concept} with ${headers.length} columns`);
  }
  return tts;
}

/**
 * ENHANCED seedTTSFromSpecs - Works with complete column structure
 */
function seedTTSFromSpecs(concept, moduleName, specText){
  const tts = ensureTTSSheet(concept);
  const norm = s => String(s||'').replace(/\s+/g,' ').trim();

  // Keep header + rows for other modules, remove rows for this one
  const last = tts.getLastRow();
  const headerCount = 18; // Complete column count
  const header = [['Module Name','Slide Number','Slide Content','Speaker Notes','Duration (sec)','Slides (PPT-ready)','Audio (WAV)','Image Prompt','Notes', 'Alternate Slide Content', 'TTS Script', 'Audio Status', 'Slide Design Notes', 'Learning Objectives', 'Interactive Elements', 'Quality Check', 'Last Updated', 'Generated By']];
  
  const keep = [];
  for (let r=2; r<=last; r++){
    const mod = norm(tts.getRange(r,1).getValue());
    if (mod !== norm(moduleName)){
      // Ensure we capture all columns, padding if necessary
      const existingRow = tts.getRange(r,1,1,headerCount).getValues()[0];
      keep.push(existingRow);
    }
  }
  
  tts.clearContents();
  tts.getRange(1,1,1,headerCount).setValues(header);
  if (keep.length) tts.getRange(2,1,keep.length,headerCount).setValues(keep);

  // ENHANCED: Generate sophisticated slide content
  const slides = parseSlideSpecs(specText);
  
  // Show progress for slide content generation
  trackProgress('Enhanced Slide Content Generation', 0, slides.length, 'Generating executive-level slide content...');
  
  const rows = [];
  const timestamp = new Date().toISOString().slice(0,19).replace('T', ' ');
  
  for (let i = 0; i < slides.length; i++) {
    const slide = slides[i];
    
    trackProgress('Enhanced Slide Content Generation', i + 1, slides.length, `Generating content for slide ${i + 1}...`);
    
    try {
      // Create sophisticated slide content using executive-level prompts
      const bulletPoints = (slide.body || []).map(b => b.replace(/^\s*[-*•]\s*/, '').trim()).join('. ');
      
      // Clean the title to remove any formatting artifacts
      const cleanTitle = slide.title.replace(/^#+\s*/, '').replace(/^\*\*/, '').replace(/\*\*$/, '').replace(/^SLIDE TITLE:\s*/i, '').trim();
      
      const slideContentPrompt = brandHeader_() + `
Create sophisticated, executive-level slide content for a healthcare professional development presentation. This is slide ${i+1} in the "${concept}" module "${moduleName}".

USE THIS EXACT TITLE: ${cleanTitle}
CONCEPTS TO TRANSFORM INTO SOPHISTICATED CONTENT: ${bulletPoints}

REQUIREMENTS FOR EXECUTIVE SLIDE CONTENT:

1. FORMAT: Create Title + Body format content (completely transform bullet points):
   - Start with a clear, professional title
   - Follow with 2-3 cohesive paragraphs that flow naturally  
   - Transform the concepts into a sophisticated narrative discussion
   - Eliminate all bullet point formatting and structure

2. CONTENT SOPHISTICATION: Write for senior healthcare professionals:
   - Assume advanced clinical knowledge
   - Focus on practical application and systems thinking
   - Include leadership and supervision implications where relevant

3. NO CITATIONS OR REFERENCES: This is slide content, not academic material:
   - Do NOT include any numbered citations [1], [2], [3]
   - Do NOT reference specific guidelines by name and number
   - Do NOT include bibliographic information
   - Focus on principles and concepts without academic citations

4. AUSTRALIAN HEALTHCARE CONTEXT: Reference concepts naturally:
   - Mention general practice standards and frameworks
   - Reference supervision principles and best practices
   - Include Australian healthcare context without specific citations
   - Focus on practical application in Australian settings

5. PROFESSIONAL TONE: Use authoritative yet accessible language:
   - Write for peer-to-peer professional communication
   - Include relevant clinical scenarios or practice examples
   - Reference contemporary challenges in Australian healthcare
   - Avoid academic language - focus on practical wisdom

6. ENGAGEMENT: Include elements that prompt professional reflection:
   - Connect principles to practical application
   - Reference implications for practice improvement
   - Draw on established best practices without citing sources

7. LENGTH: Aim for 50-60 words of substantive content.

8. FORMATTING REQUIREMENTS:
   - NO citations, references, or numbered sources
   - NO Markdown formatting (**, ##, etc.) - use plain text only
   - NO meta-commentary or introductory phrases
   - Return ONLY the slide content - no explanatory text

9. CRITICAL TITLE FORMATTING:
   - Start with a clean, simple title (no "SLIDE TITLE:", no "**", no "##")
   - Use the original slide title from the specifications without modification
   - Follow title immediately with body paragraphs
   - Example format: "Coaching Techniques for IMGs" (not "SLIDE TITLE: Coaching Techniques for IMGs")

10. CRITICAL: DO NOT USE BULLET POINTS IN OUTPUT:
    - Transform all concepts into flowing paragraphs
    - Use sophisticated prose, not lists or bullet structures
    - Create cohesive narrative content suitable for executive presentation

11. FOCUS ON PRACTICAL WISDOM:
    - Emphasise actionable insights and applications
    - Use conversational authority rather than academic citations
    - Reference established principles without formal documentation

Generate slide content that demonstrates practical wisdom and professional insight without academic references. This content will be displayed on slides, not in research papers. 

CRITICAL: Begin your response with the exact title provided above ("${cleanTitle}") followed immediately by the body content. Do not modify, format, or add prefixes to the title.

Return ONLY the slide content with no additional commentary.`;

      // Generate enhanced slide content
      const enhancedContent = au(callGeminiWithRetry(slideContentPrompt, 1200));
      const slideContent = String(enhancedContent || slide.title).trim();
      
      // Generate image prompt for this slide
      const imagePrompt = generateImagePrompt(slideContent, concept, moduleName);
      
      // Generate TTS-optimised script
      const ttsScript = generateTTSScript(slideContent);
      
      // Estimate duration (rough calculation: 150 words per minute)
      const wordCount = slideContent.split(/\s+/).length;
      const estimatedDuration = Math.round((wordCount / 150) * 60); // seconds
      
      // Create complete row with all 18 columns (A-R)
      rows.push([
        moduleName,              // A - Module Name
        i+1,                    // B - Slide Number
        slideContent,           // C - Slide Content
        '',                     // D - Speaker Notes (to be filled)
        estimatedDuration,      // E - Duration (sec)
        '',                     // F - Slides (PPT-ready)
        '',                     // G - Audio (WAV)
        imagePrompt,            // H - Image Prompt
        '',                     // I - Notes
        '',                     // J - Alternate Slide Content
        ttsScript,              // K - TTS Script
        'Pending',              // L - Audio Status
        '',                     // M - Slide Design Notes
        '',                     // N - Learning Objectives
        '',                     // O - Interactive Elements
        'Generated',            // P - Quality Check
        timestamp,              // Q - Last Updated
        'AI-Enhanced'           // R - Generated By
      ]);
      
      // Rate limiting between slides
      if (i < slides.length - 1) {
        Utilities.sleep(6000); // 6 seconds between requests
      }
      
    } catch (error) {
      console.error(`Error generating content for slide ${i+1}:`, error.message);
      // Fallback to improved bullet format if AI generation fails
      const fallbackContent = `${slide.title}\n\n${(slide.body || []).map(b => b.replace(/^\s*[-*•]\s*/, '').trim()).join('. ')}`;
      const fallbackImagePrompt = generateImagePrompt(fallbackContent, concept, moduleName);
      const fallbackTTSScript = generateTTSScript(fallbackContent);
      const wordCount = fallbackContent.split(/\s+/).length;
      const estimatedDuration = Math.round((wordCount / 150) * 60);
      
      rows.push([
        moduleName,              // A - Module Name
        i+1,                    // B - Slide Number
        fallbackContent,        // C - Slide Content
        '',                     // D - Speaker Notes
        estimatedDuration,      // E - Duration (sec)
        '',                     // F - Slides (PPT-ready)
        '',                     // G - Audio (WAV)
        fallbackImagePrompt,    // H - Image Prompt
        'Fallback content',     // I - Notes
        '',                     // J - Alternate Slide Content
        fallbackTTSScript,      // K - TTS Script
        'Pending',              // L - Audio Status
        '',                     // M - Slide Design Notes
        '',                     // N - Learning Objectives
        '',                     // O - Interactive Elements
        'Generated (Fallback)', // P - Quality Check
        timestamp,              // Q - Last Updated
        'AI-Fallback'          // R - Generated By
      ]);
    }
  }
  
  if (rows.length){
    const start = tts.getLastRow()+1;
    tts.getRange(start,1,rows.length,headerCount).setValues(rows);
  }
  
  trackProgress('Enhanced Slide Content Generation', slides.length, slides.length, 'Complete!');
  SpreadsheetApp.getUi().alert(`Generated ${rows.length} sophisticated slide content entries for "${moduleName}" with complete workflow structure (${headerCount} columns).`);
}

/**
 * Helper function: Generate TTS-optimised script
 */
function generateTTSScript(slideContent) {
  // Convert slide content to TTS-friendly format
  let ttsScript = slideContent
    .replace(/\n\n+/g, '. ') // Convert paragraph breaks to pauses
    .replace(/([.!?])\s+/g, '$1 ') // Ensure single space after sentences
    .replace(/\s+/g, ' ') // Normalise whitespace
    .trim();
    
  // Add natural pauses for TTS
  ttsScript = ttsScript.replace(/([.!?])/g, '$1 <break time="0.5s"/>');
  
  return ttsScript;
}

/**
 * DEPLOYMENT INSTRUCTIONS:
 * 
 * 1. BACKUP your current TTS-related functions
 * 2. REPLACE ensureTTSSheet() with the enhanced version above
 * 3. REPLACE seedTTSFromSpecs() with the enhanced version above
 * 4. ADD the generateTTSScript() helper function
 * 5. TEST by creating a new TTS sheet to verify all columns are present
 * 
 * CRITICAL FIXES:
 * - Expanded from 10 columns (A-J) to 18 columns (A-R)
 * - Restored essential workflow columns that were missing
 * - Enhanced column width settings for better usability
 * - Added proper header formatting and freezing
 * - Included TTS Script generation for audio workflow
 * - Added duration estimation
 * - Complete workflow tracking columns
 * 
 * COLUMNS RESTORED:
 * K: TTS Script - Essential for audio generation
 * L: Audio Status - Track audio generation progress  
 * M: Slide Design Notes - Visual design specifications
 * N: Learning Objectives - Slide-specific goals
 * O: Interactive Elements - Engagement features
 * P: Quality Check - Review and approval status
 * Q: Last Updated - Modification timestamp
 * R: Generated By - Attribution/version control
 */