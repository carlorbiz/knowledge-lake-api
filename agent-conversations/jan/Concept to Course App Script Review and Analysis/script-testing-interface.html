<!DOCTYPE html>
<html lang="en-AU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Testing Interface | Concept-to-Course Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .code-block { background-color: #1e293b; color: #e2e8f0; border-radius: 8px; padding: 16px; font-family: 'Monaco', 'Consolas', monospace; font-size: 0.9em; overflow-x: auto; }
        .test-card { transition: all 0.3s ease; }
        .test-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .status-pass { color: #10b981; }
        .status-fail { color: #ef4444; }
        .status-warning { color: #f59e0b; }
        .test-result { border-left: 4px solid; padding: 12px; margin: 8px 0; border-radius: 4px; }
        .test-pass { border-color: #10b981; background: #f0fdf4; }
        .test-fail { border-color: #ef4444; background: #fef2f2; }
        .test-warning { border-color: #f59e0b; background: #fffbeb; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-purple-600 to-indigo-700 text-white shadow-lg">
        <div class="container mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold mb-1">Script Testing Interface</h1>
                    <p class="text-purple-100">Comprehensive testing suite for Google Apps Script functions</p>
                </div>
                <a href="concept-to-course-manager.html" class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Hub
                </a>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Test Categories -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Test Categories</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <!-- Configuration Tests -->
                <div class="test-card bg-white rounded-lg p-6 shadow-md border-l-4 border-blue-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-800">Configuration Tests</h3>
                        <i class="fas fa-cogs text-blue-500 text-xl"></i>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Validate script properties and API access</p>
                    <button onclick="runConfigurationTests()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition">
                        Run Tests
                    </button>
                </div>

                <!-- PDF Processing Tests -->
                <div class="test-card bg-white rounded-lg p-6 shadow-md border-l-4 border-red-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-800">PDF Processing Tests</h3>
                        <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Critical PDF detection and processing validation</p>
                    <button onclick="runPDFTests()" class="w-full bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700 transition">
                        Run Tests
                    </button>
                </div>

                <!-- Function Integration Tests -->
                <div class="test-card bg-white rounded-lg p-6 shadow-md border-l-4 border-green-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-800">Function Tests</h3>
                        <i class="fas fa-code text-green-500 text-xl"></i>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Workflow function integration verification</p>
                    <button onclick="runFunctionTests()" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 transition">
                        Run Tests
                    </button>
                </div>

            </div>
        </section>

        <!-- Test Results Display -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Test Results</h2>
            <div id="test-results" class="bg-white rounded-lg p-6 shadow-md min-h-48">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-play-circle text-4xl mb-4"></i>
                    <p>Select a test category above to begin testing</p>
                </div>
            </div>
        </section>

        <!-- Testing Functions for Deployment -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-code-branch text-purple-600 mr-2"></i>
                Testing Functions for Deployment
            </h2>
            
            <div class="space-y-6">
                
                <!-- Configuration Test Function -->
                <div class="bg-white rounded-lg p-6 shadow-md">
                    <h3 class="font-bold text-lg mb-4">
                        <i class="fas fa-cogs text-blue-600 mr-2"></i>
                        Configuration Test Function
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Deploy this function to test all configuration settings and API access.</p>
                    
                    <div class="code-block mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-400">testConfiguration.gs</span>
                            <button onclick="copyToClipboard('config-test-code')" class="text-xs bg-blue-600 text-white px-2 py-1 rounded">
                                <i class="fas fa-copy mr-1"></i>Copy
                            </button>
                        </div>
                        <pre id="config-test-code">/**
 * CONFIGURATION TESTING FUNCTION
 * Add to your Google Apps Script to validate all settings
 */
function testConfiguration() {
  const results = [];
  const ui = SpreadsheetApp.getUi();
  
  try {
    // Test 1: Script Properties
    console.log('Testing Script Properties...');
    try {
      CFG.validateConfiguration();
      results.push('✅ Configuration: All script properties valid');
    } catch (e) {
      results.push(`❌ Configuration: ${e.message}`);
    }
    
    // Test 2: Gemini API Access
    console.log('Testing Gemini API...');
    try {
      const testPrompt = 'Hello, respond with "API_TEST_SUCCESS" only.';
      const response = callGemini_(testPrompt, 50);
      if (response.includes('API_TEST_SUCCESS') || response.includes('success')) {
        results.push('✅ Gemini API: Connection successful');
      } else {
        results.push('⚠️ Gemini API: Connected but unexpected response');
      }
    } catch (e) {
      results.push(`❌ Gemini API: ${e.message}`);
    }
    
    // Test 3: Drive Folder Access
    console.log('Testing Drive folder access...');
    try {
      const folder = DriveApp.getFolderById(CFG.DRIVE_FOLDER_ID);
      const folderName = folder.getName();
      results.push(`✅ Drive Folder: Access confirmed (${folderName})`);
    } catch (e) {
      results.push(`❌ Drive Folder: ${e.message}`);
    }
    
    // Test 4: Slides Template Access
    console.log('Testing slides template...');
    try {
      const template = DriveApp.getFileById(CFG.SLIDES_TEMPLATE_ID);
      const templateName = template.getName();
      results.push(`✅ Slides Template: Access confirmed (${templateName})`);
    } catch (e) {
      results.push(`❌ Slides Template: ${e.message}`);
    }
    
    // Display results
    const summary = results.join('\n');
    console.log('=== CONFIGURATION TEST RESULTS ===');
    console.log(summary);
    
    ui.alert(
      'Configuration Test Complete',
      summary,
      ui.ButtonSet.OK
    );
    
  } catch (error) {
    const errorMsg = `Fatal test error: ${error.message}`;
    console.log(errorMsg);
    ui.alert('Test Error', errorMsg, ui.ButtonSet.OK);
  }
}</pre>
                    </div>
                </div>

                <!-- PDF Processing Test Function -->
                <div class="bg-white rounded-lg p-6 shadow-md">
                    <h3 class="font-bold text-lg mb-4">
                        <i class="fas fa-file-pdf text-red-600 mr-2"></i>
                        Enhanced PDF Processing Test
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Comprehensive PDF processing pipeline test with detailed logging.</p>
                    
                    <div class="code-block mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-400">testPDFProcessing.gs</span>
                            <button onclick="copyToClipboard('pdf-test-code')" class="text-xs bg-red-600 text-white px-2 py-1 rounded">
                                <i class="fas fa-copy mr-1"></i>Copy
                            </button>
                        </div>
                        <pre id="pdf-test-code">/**
 * ENHANCED PDF PROCESSING TEST
 * Comprehensive testing for PDF detection and processing pipeline
 */
function testPDFProcessingComplete() {
  const ui = SpreadsheetApp.getUi();
  const sh = SpreadsheetApp.getActiveSheet();
  
  if (sh.getName() !== 'Mapping') {
    return ui.alert('Error', 'Run this test on the Mapping tab with a course row selected.', ui.ButtonSet.OK);
  }
  
  const row = sh.getActiveRange().getRow();
  if (row < 2) {
    return ui.alert('Error', 'Select a course row (row 2 or higher).', ui.ButtonSet.OK);
  }
  
  const results = [];
  
  try {
    const concept = sh.getRange(row, 1).getValue();
    const b2Value = sh.getRange(row, 2).getValue();
    
    console.log('=== PDF PROCESSING TEST START ===');
    console.log(`Testing concept: ${concept}`);
    console.log(`B2 folder: ${b2Value}`);
    
    // Test 1: B2 Folder Validation
    if (!b2Value || !String(b2Value).includes('drive.google.com/folders/')) {
      results.push('❌ B2 Validation: Not a valid Google Drive folder URL');
      ui.alert('Test Results', results.join('\n'), ui.ButtonSet.OK);
      return;
    }
    results.push('✅ B2 Validation: Valid Google Drive folder URL detected');
    
    // Test 2: Folder Access
    const folderMatch = String(b2Value).match(/\/folders\/([a-zA-Z0-9_-]+)/);
    if (!folderMatch) {
      results.push('❌ Folder ID: Could not extract folder ID from URL');
      ui.alert('Test Results', results.join('\n'), ui.ButtonSet.OK);
      return;
    }
    
    const folderId = folderMatch[1];
    let folder;
    try {
      folder = DriveApp.getFolderById(folderId);
      results.push(`✅ Folder Access: Successfully accessed "${folder.getName()}"`);
    } catch (e) {
      results.push(`❌ Folder Access: ${e.message}`);
      ui.alert('Test Results', results.join('\n'), ui.ButtonSet.OK);
      return;
    }
    
    // Test 3: Manual PDF Scan
    let pdfFiles = [];
    let totalFiles = 0;
    const files = folder.getFiles();
    
    while (files.hasNext()) {
      const file = files.next();
      totalFiles++;
      const mimeType = file.getBlob().getContentType();
      console.log(`File found: ${file.getName()} (${mimeType})`);
      
      if (mimeType === 'application/pdf') {
        pdfFiles.push({
          name: file.getName(),
          id: file.getId(),
          size: file.getSize()
        });
      }
    }
    
    results.push(`✅ Folder Scan: ${totalFiles} total files, ${pdfFiles.length} PDFs found`);
    
    if (pdfFiles.length === 0) {
      results.push('⚠️ PDF Detection: No PDF files found in folder');
      results.push('   This explains why PDFs are not mentioned in recommendations');
    } else {
      results.push(`✅ PDF Detection: Found ${pdfFiles.length} PDF files:`);
      pdfFiles.forEach((pdf, index) => {
        results.push(`   ${index + 1}. ${pdf.name} (${Math.round(pdf.size/1024)}KB)`);
      });
    }
    
    // Test 4: Function Existence Check
    if (typeof collectAllSourceMaterials_ === 'function') {
      results.push('✅ Function Check: collectAllSourceMaterials_ exists');
      
      // Test 5: Actual Function Call
      try {
        const srcPack = collectAllSourceMaterials_(row);
        results.push(`✅ Function Call: collectAllSourceMaterials_ executed successfully`);
        results.push(`   Text content: ${srcPack.text ? Math.round(srcPack.text.length/1000) : 0}k characters`);
        results.push(`   Sources found: ${srcPack.sources ? srcPack.sources.length : 0}`);
        results.push(`   PDFs detected: ${srcPack.pdfFiles ? srcPack.pdfFiles.length : 0}`);
        results.push(`   Errors: ${srcPack.errors ? srcPack.errors.length : 0}`);
        
        if (srcPack.pdfFiles && srcPack.pdfFiles.length > 0) {
          results.push('✅ PDF Processing: PDFs successfully detected by function');
        } else {
          results.push('❌ PDF Processing: Function did not detect PDFs');
          results.push('   This is the root cause of your issue');
        }
        
      } catch (e) {
        results.push(`❌ Function Call: collectAllSourceMaterials_ failed: ${e.message}`);
      }
    } else {
      results.push('❌ Function Check: collectAllSourceMaterials_ not found');
    }
    
    // Test 6: Gemini PDF Function Check
    if (typeof callGeminiWithPDFs === 'function') {
      results.push('✅ Gemini PDF: callGeminiWithPDFs function exists');
    } else {
      results.push('❌ Gemini PDF: callGeminiWithPDFs function not found');
    }
    
    console.log('=== TEST RESULTS ===');
    results.forEach(result => console.log(result));
    
    const summary = results.join('\n');
    ui.alert(
      'PDF Processing Test Complete',
      summary,
      ui.ButtonSet.OK
    );
    
  } catch (error) {
    const errorMsg = `Test failed: ${error.message}`;
    console.log(errorMsg);
    ui.alert('Test Error', errorMsg, ui.ButtonSet.OK);
  }
}</pre>
                    </div>
                </div>

                <!-- Function Integration Test -->
                <div class="bg-white rounded-lg p-6 shadow-md">
                    <h3 class="font-bold text-lg mb-4">
                        <i class="fas fa-code text-green-600 mr-2"></i>
                        Function Integration Test
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Test critical function availability and integration points.</p>
                    
                    <div class="code-block mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-400">testFunctionIntegration.gs</span>
                            <button onclick="copyToClipboard('function-test-code')" class="text-xs bg-green-600 text-white px-2 py-1 rounded">
                                <i class="fas fa-copy mr-1"></i>Copy
                            </button>
                        </div>
                        <pre id="function-test-code">/**
 * FUNCTION INTEGRATION TEST
 * Verify all critical functions exist and are properly integrated
 */
function testFunctionIntegration() {
  const ui = SpreadsheetApp.getUi();
  const results = [];
  
  console.log('=== FUNCTION INTEGRATION TEST ===');
  
  // List of critical functions to check
  const criticalFunctions = [
    'onOpen',
    'launchCourseCreationWizard',
    'setupMappingTab_',
    'collectAllSourceMaterials_',
    'generateCourseRecommendation_',
    'extractModulesFromRecommendation_',
    'callGemini_',
    'callGeminiWithPDFs',
    'archiveCourse',
    'refreshHowToUseTab',
    'brandHeader_',
    'brandHeaderWithCitations_'
  ];
  
  // Test function existence
  criticalFunctions.forEach(funcName => {
    try {
      const func = eval(funcName);
      if (typeof func === 'function') {
        results.push(`✅ ${funcName}: Function exists`);
        console.log(`✅ ${funcName}: OK`);
      } else {
        results.push(`❌ ${funcName}: Not a function`);
        console.log(`❌ ${funcName}: Not a function`);
      }
    } catch (e) {
      results.push(`❌ ${funcName}: Not found or error`);
      console.log(`❌ ${funcName}: ${e.message}`);
    }
  });
  
  // Test menu integration
  try {
    onOpen();
    results.push('✅ Menu Integration: onOpen executed successfully');
  } catch (e) {
    results.push(`❌ Menu Integration: onOpen failed - ${e.message}`);
  }
  
  // Test configuration object
  if (typeof CFG === 'object') {
    results.push('✅ Configuration: CFG object exists');
    
    const configMethods = ['validateConfiguration', 'trackApiUsage', 'getBatchSize'];
    configMethods.forEach(method => {
      if (typeof CFG[method] === 'function') {
        results.push(`✅ CFG.${method}: Method exists`);
      } else {
        results.push(`❌ CFG.${method}: Method missing`);
      }
    });
  } else {
    results.push('❌ Configuration: CFG object not found');
  }
  
  // Test brand header functions
  try {
    const header = brandHeader_();
    if (header && header.includes('GPSA')) {
      results.push('✅ Brand Header: Generated successfully with GPSA branding');
    } else {
      results.push('⚠️ Brand Header: Generated but may be missing GPSA content');
    }
  } catch (e) {
    results.push(`❌ Brand Header: Failed - ${e.message}`);
  }
  
  // Summary
  const passCount = results.filter(r => r.startsWith('✅')).length;
  const failCount = results.filter(r => r.startsWith('❌')).length;
  const warnCount = results.filter(r => r.startsWith('⚠️')).length;
  
  results.unshift(`=== SUMMARY ===`);
  results.unshift(`✅ Passed: ${passCount}`);
  results.unshift(`❌ Failed: ${failCount}`);
  results.unshift(`⚠️ Warnings: ${warnCount}`);
  results.unshift('');
  
  const summary = results.join('\n');
  console.log(summary);
  
  ui.alert(
    'Function Integration Test Complete',
    summary,
    ui.ButtonSet.OK
  );
}</pre>
                    </div>
                </div>

            </div>
        </section>

        <!-- Deployment Instructions -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Deployment Instructions</h2>
            <div class="bg-white rounded-lg p-6 shadow-md">
                <div class="space-y-4">
                    <div class="flex items-start space-x-3">
                        <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold flex-shrink-0 mt-1">1</span>
                        <div>
                            <h4 class="font-semibold">Open Google Apps Script</h4>
                            <p class="text-sm text-gray-600">Navigate to your Concept-to-Course Google Apps Script project</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold flex-shrink-0 mt-1">2</span>
                        <div>
                            <h4 class="font-semibold">Add Test Functions</h4>
                            <p class="text-sm text-gray-600">Copy and paste the testing functions above into your script</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold flex-shrink-0 mt-1">3</span>
                        <div>
                            <h4 class="font-semibold">Run Tests</h4>
                            <p class="text-sm text-gray-600">Execute each test function and review the results in both the UI alerts and console logs</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3">
                        <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold flex-shrink-0 mt-1">4</span>
                        <div>
                            <h4 class="font-semibold">Analyse Results</h4>
                            <p class="text-sm text-gray-600">Review test outputs to identify specific issues with PDF processing or function integration</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- JavaScript -->
    <script>
        // Copy to clipboard function
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent || element.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                const button = event.target.closest('button');
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                button.classList.add('bg-green-600');
                button.classList.remove('bg-blue-600', 'bg-red-600', 'bg-green-600');
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('bg-green-600');
                    // Restore original color based on the code block type
                    if (elementId.includes('config')) {
                        button.classList.add('bg-blue-600');
                    } else if (elementId.includes('pdf')) {
                        button.classList.add('bg-red-600');
                    } else {
                        button.classList.add('bg-green-600');
                    }
                }, 2000);
            });
        }

        // Simulated test functions for the web interface
        function runConfigurationTests() {
            showTestResults([
                { type: 'pass', message: 'Script Properties: All required properties configured' },
                { type: 'fail', message: 'Gemini API: Requires testing in Google Apps Script environment' },
                { type: 'warning', message: 'Drive Folder: Access verification needed in script' },
                { type: 'pass', message: 'Configuration Object: CFG structure valid' }
            ], 'Configuration Tests');
        }

        function runPDFTests() {
            showTestResults([
                { type: 'fail', message: 'PDF Detection: Critical issue - PDFs not being processed in recommendations' },
                { type: 'warning', message: 'B2 Folder Scanning: Requires investigation in actual environment' },
                { type: 'pass', message: 'callGeminiWithPDFs Function: Structure appears correct' },
                { type: 'fail', message: 'collectAllSourceMaterials_: May not be populating pdfFiles array correctly' }
            ], 'PDF Processing Tests');
        }

        function runFunctionTests() {
            showTestResults([
                { type: 'pass', message: 'Core Functions: Most functions appear to be implemented' },
                { type: 'pass', message: 'Menu Integration: onOpen function enhanced with wizard' },
                { type: 'warning', message: 'Archival Function: Enhanced version ready for deployment' },
                { type: 'pass', message: 'Brand Headers: Australian healthcare compliance maintained' }
            ], 'Function Integration Tests');
        }

        function showTestResults(results, testName) {
            const resultsContainer = document.getElementById('test-results');
            
            let html = `<h3 class="text-lg font-semibold mb-4">${testName} - Results</h3>`;
            html += '<div class="space-y-2">';
            
            results.forEach(result => {
                let cssClass = '';
                let icon = '';
                
                switch(result.type) {
                    case 'pass':
                        cssClass = 'test-pass';
                        icon = '✅';
                        break;
                    case 'fail':
                        cssClass = 'test-fail';
                        icon = '❌';
                        break;
                    case 'warning':
                        cssClass = 'test-warning';
                        icon = '⚠️';
                        break;
                }
                
                html += `<div class="test-result ${cssClass}">
                    <span class="font-mono text-sm">${icon} ${result.message}</span>
                </div>`;
            });
            
            html += '</div>';
            
            html += `<div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h4 class="font-semibold text-blue-800 mb-2">Next Steps</h4>
                <p class="text-blue-700 text-sm">These are simulated results. Deploy the actual test functions to your Google Apps Script for comprehensive analysis.</p>
            </div>`;
            
            resultsContainer.innerHTML = html;
        }
    </script>
</body>
</html>